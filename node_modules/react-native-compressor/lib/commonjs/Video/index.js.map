{"version":3,"sources":["index.tsx"],"names":["VideoCompressEventEmitter","NativeEventEmitter","NativeModules","VideoCompressor","NativeVideoCompressor","backgroundUpload","url","fileUrl","options","onProgress","uuid","subscription","addListener","event","data","written","total","Platform","OS","includes","replace","result","upload","method","httpMethod","headers","remove","cancelCompression","cancellationId","Video","compress","progress","modifiedOptions","bitrate","compressionMethod","maxSize","minimumFileSizeForCompress","undefined","getCancellationId","activateBackgroundTask","onExpired","deactivateBackgroundTask","removeAllListeners"],"mappings":"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","sourcesContent":["import {\n  NativeModules,\n  NativeEventEmitter,\n  Platform,\n  NativeEventSubscription,\n} from 'react-native';\nimport { uuidv4 } from '../utils';\n\nexport declare enum FileSystemUploadType {\n  BINARY_CONTENT = 0,\n  MULTIPART = 1,\n}\n\nexport declare type FileSystemAcceptedUploadHttpMethod =\n  | 'POST'\n  | 'PUT'\n  | 'PATCH';\nexport type compressionMethod = 'auto' | 'manual';\ntype videoCompresssionType = {\n  bitrate?: number;\n  maxSize?: number;\n  compressionMethod?: compressionMethod;\n  minimumFileSizeForCompress?: number;\n  getCancellationId?: (cancellationId: string) => void;\n};\n\nexport declare enum FileSystemSessionType {\n  BACKGROUND = 0,\n  FOREGROUND = 1,\n}\n\nexport declare type HTTPResponse = {\n  status: number;\n  headers: Record<string, string>;\n  body: string;\n};\n\nexport declare type FileSystemUploadOptions = (\n  | {\n      uploadType?: FileSystemUploadType.BINARY_CONTENT;\n    }\n  | {\n      uploadType: FileSystemUploadType.MULTIPART;\n      fieldName?: string;\n      mimeType?: string;\n      parameters?: Record<string, string>;\n    }\n) & {\n  headers?: Record<string, string>;\n  httpMethod?: FileSystemAcceptedUploadHttpMethod;\n  sessionType?: FileSystemSessionType;\n};\n\nexport type VideoCompressorType = {\n  compress(\n    fileUrl: string,\n    options?: videoCompresssionType,\n    onProgress?: (progress: number) => void\n  ): Promise<string>;\n  cancelCompression(cancellationId: string): void;\n  backgroundUpload(\n    url: string,\n    fileUrl: string,\n    options: FileSystemUploadOptions,\n    onProgress?: (writtem: number, total: number) => void\n  ): Promise<any>;\n  activateBackgroundTask(onExpired?: (data: any) => void): Promise<any>;\n  deactivateBackgroundTask(): Promise<any>;\n};\n\nconst VideoCompressEventEmitter = new NativeEventEmitter(\n  NativeModules.VideoCompressor\n);\n\nconst NativeVideoCompressor = NativeModules.VideoCompressor;\n\nexport const backgroundUpload = async (\n  url: string,\n  fileUrl: string,\n  options: FileSystemUploadOptions,\n  onProgress?: (writtem: number, total: number) => void\n): Promise<any> => {\n  const uuid = uuidv4();\n  let subscription: NativeEventSubscription;\n  try {\n    if (onProgress) {\n      subscription = VideoCompressEventEmitter.addListener(\n        'VideoCompressorProgress',\n        (event: any) => {\n          if (event.uuid === uuid) {\n            onProgress(event.data.written, event.data.total);\n          }\n        }\n      );\n    }\n    if (Platform.OS === 'android' && fileUrl.includes('file://')) {\n      fileUrl = fileUrl.replace('file://', '');\n    }\n    const result = await NativeVideoCompressor.upload(fileUrl, {\n      uuid,\n      method: options.httpMethod,\n      headers: options.headers,\n      url,\n    });\n    return result;\n  } finally {\n    // @ts-ignore\n    if (subscription) {\n      subscription.remove();\n    }\n  }\n};\n\nexport const cancelCompression = (cancellationId: string) => {\n  return NativeVideoCompressor.cancelCompression(cancellationId);\n};\n\nconst Video: VideoCompressorType = {\n  compress: async (\n    fileUrl: string,\n    options?: videoCompresssionType,\n    onProgress?: (progress: number) => void\n  ) => {\n    const uuid = uuidv4();\n    let subscription: NativeEventSubscription;\n    try {\n      if (onProgress) {\n        subscription = VideoCompressEventEmitter.addListener(\n          'videoCompressProgress',\n          (event: any) => {\n            if (event.uuid === uuid) {\n              onProgress(event.data.progress);\n            }\n          }\n        );\n      }\n      const modifiedOptions: {\n        uuid: string;\n        bitrate?: number;\n        compressionMethod?: compressionMethod;\n        maxSize?: number;\n        minimumFileSizeForCompress?: number;\n      } = { uuid };\n      if (options?.bitrate) modifiedOptions.bitrate = options?.bitrate;\n      if (options?.compressionMethod) {\n        modifiedOptions.compressionMethod = options?.compressionMethod;\n      } else {\n        modifiedOptions.compressionMethod = 'manual';\n      }\n      if (options?.maxSize) {\n        modifiedOptions.maxSize = options?.maxSize;\n      } else {\n        modifiedOptions.maxSize = 640;\n      }\n      if (options?.minimumFileSizeForCompress !== undefined) {\n        modifiedOptions.minimumFileSizeForCompress =\n          options?.minimumFileSizeForCompress;\n      }\n      if (options?.getCancellationId) {\n        options?.getCancellationId(uuid);\n      }\n      const result = await NativeVideoCompressor.compress(\n        fileUrl,\n        modifiedOptions\n      );\n      return result;\n    } finally {\n      // @ts-ignore\n      if (subscription) {\n        subscription.remove();\n      }\n    }\n  },\n  backgroundUpload,\n  cancelCompression,\n  activateBackgroundTask(onExpired?) {\n    if (onExpired) {\n      const subscription: NativeEventSubscription =\n        VideoCompressEventEmitter.addListener(\n          'backgroundTaskExpired',\n          (event: any) => {\n            onExpired(event);\n            if (subscription) {\n              subscription.remove();\n            }\n          }\n        );\n    }\n    return NativeVideoCompressor.activateBackgroundTask({});\n  },\n  deactivateBackgroundTask() {\n    VideoCompressEventEmitter.removeAllListeners('backgroundTaskExpired');\n    return NativeVideoCompressor.deactivateBackgroundTask({});\n  },\n} as VideoCompressorType;\n\nexport default Video;\n"]}